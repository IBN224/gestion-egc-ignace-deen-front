<app-nav-bar></app-nav-bar>
<div class="container">
  <div class="card">
    <div class="card-header bg-dark">
      <div class="row">
        <div class="col-md-6">
          <h4 class="card-title"><strong style="color: whitesmoke">
            Gestion Resultat Examen</strong></h4>
        </div>
        <div *ngIf="mode==0" class="col-md-6" style="text-align: right">
          <button class="btn btn-secondary btn-sm" style="border-color: white"
                  (click)="newTestResult()">
                         <span class="btn-label">
                             <i class="nc-icon nc-simple-add"></i>
                         </span>
            Nouveau
          </button>
        </div>
        <div *ngIf="mode==1" class="col-md-6" style="text-align: right">
          <button class="btn btn-secondary btn-sm" style="border-color: white"
                  (click)="goToList()">
                         <span class="btn-label">
                             <i class="nc-icon nc-bullet-list-67"></i>
                         </span>
            Liste
          </button>
        </div>
        <div *ngIf="mode==2" class="col-md-6" style="text-align: right">
          <button class="btn btn-secondary btn-sm" style="border-color: white"
                  (click)="mode=0;">
                       <span class="btn-label">
                           <i class="fa fa-arrow-left"></i>
                       </span>
            Retour
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div *ngIf="mode==1">
        <form [formGroup]="testResultFormGroup">
          <div class="row">
            <div class="col-md-3">
              <div class="form-group">
                <label class="label-important">Date</label>
                <input class="form-control" type="date" formControlName="date"
                       [ngClass]="{'is-invalid':submitted && testResultFormGroup.controls.date.errors}"/>
                <div *ngIf="submitted && testResultFormGroup.controls.date.errors" class="invalid-feedback">
                  <div *ngIf="testResultFormGroup.controls.date.errors.required">Date is required</div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label class="label-important">Catégorie</label>
                <select #categorie class="form-control" formControlName="categorie" (change)="categorieChanged(categorie.value)"
                        [ngClass]="{'is-invalid':submitted && testResultFormGroup.controls.categorie.value=='undefined'}">
                  <option disabled value="undefined">Catégories......</option>
                  <option value=0>PATIENT</option>
                  <option value=1>PERSONNEL</option>
                </select>
                <div *ngIf="submitted && testResultFormGroup.controls.categorie.value=='undefined'" class="invalid-feedback">
                  <div *ngIf="testResultFormGroup.controls.categorie.value=='undefined'">Categorie is required</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div *ngIf="catOption==0" class="form-group">
                <label class="label-important">Patient</label>
                <ng-select2 [data]="dataPatient"
                            width="100%"
                            formControlName="patient"
                            [placeholder]="'Sélectionner un patient...'"
                            [ngClass]="{'is-invalid':submitted && testResultFormGroup.controls.patient.value==0}">
                </ng-select2>
                <div *ngIf="submitted && testResultFormGroup.controls.patient.value==0" class="invalid-feedback">
                  <div *ngIf="testResultFormGroup.controls.patient.value==0">Patient is required</div>
                </div>
              </div>
              <div *ngIf="catOption==1" class="form-group">
                <label class="label-important">Personnel</label>
                <ng-select2 [data]="dataPersonnel"
                            width="100%"
                            formControlName="personnel"
                            [placeholder]="'Sélectionner un personnel...'"
                            [ngClass]="{'is-invalid':submitted && testResultFormGroup.controls.personnel.value==0}">
                </ng-select2>
                <div *ngIf="submitted && testResultFormGroup.controls.personnel.value==0" class="invalid-feedback">
                  <div *ngIf="testResultFormGroup.controls.personnel.value==0">Personnel is required</div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                <label class="label-important">Description</label>
                <textarea class="form-control" type="text" formControlName="description"
                          [ngClass]="{'is-invalid':submitted && testResultFormGroup.controls.description.errors}">
                </textarea>
                <div *ngIf="submitted && testResultFormGroup.controls.description.errors" class="invalid-feedback">
                  <div *ngIf="testResultFormGroup.controls.description.errors.required">Description is required</div>
                </div>
              </div>
            </div>
          </div>
          <div>&nbsp;</div>
          <div class="row">
            <div class="col-md-12">
              <label style="font-size: smaller; cursor: pointer; color: aliceblue;" class="file-upload btn btn-dark btn-block rounded-pill">
                <i class="fa fa-upload mr-2"></i>Ajouter un document ...
                <input hidden type="file" accept=".pdf,.docx,.doc,.png,.jpeg,.jpg" id="contentImageCloture" name="contentImageCloture"
                       (change)="onSelectFileOut($event)">
              </label>
            </div>
          </div>
          <div class="row"><div class="col-md-1"></div>
            <div class="col-md-3 card bg-dark text-white text-center mr-2" *ngFor="let i of selectedFiles" style="font-size: 15px">
              {{i.name}}
              <button (click)="removeFileItem(i)" class="btn-sm close text-danger">X</button>
            </div>
          </div>
          <div>&nbsp;</div>
          <button type="button" class="btn btn-success" (click)="saveTestResult()">
            <i class="fa fa-save"></i>
            Enrégistrer
          </button>
        </form>
      </div>
      <div *ngIf="mode==2">
        <div>
          <div class="col-md-12">
            <h5 class="mt-2"><span class="fa fa-info-circle float-right"></span>INFO RESULTAT EXAMEN</h5>
            <table class="table table-sm table-hover table-striped">
              <tbody>
              <tr>
                <td>
                  <strong>DATE</strong> &nbsp;&nbsp;{{dateInfo | date : 'dd/MM/yyyy'}}
                </td>
              </tr>
              <tr>
                <td>
                  <strong>DESCRIPTION</strong> &nbsp;&nbsp;{{descriptionInfo}}
                </td>
              </tr>
              </tbody>
            </table>
          </div>
          <fieldset class="well the-fieldset">
            <legend class="the-legend">Specialiste</legend>
            <div>
              <table class="table table-striped table-bordered table-hover" id="sample_1">
                <tbody>
                <tr>
                  <th>NOM</th>
                  <td>{{nomSpeciaInfo}}</td>
                  <th>PRENOM</th>
                  <td>{{prenomSpeciaInfo}}</td>
                  <th>STATUS</th>
                  <td>{{statusSpeciaInfo}}</td>
                </tr>
                </tbody>
              </table>
            </div>
          </fieldset>
          <div *ngIf="searchCatOption==0">
            <fieldset class="well the-fieldset">
              <legend class="the-legend">Patient</legend>
              <div>
                <table class="table table-striped table-bordered table-hover" id="sample_4">
                  <tbody>
                  <tr>
                    <th>NOM</th>
                    <td>{{nomPatientInfo}}</td>
                    <th>PRENOM</th>
                    <td>{{prenomPatientInfo}}</td>
                    <th>ADRESSE</th>
                    <td>{{adressePatientInfo}}</td>
                    <th>TELEPHONE</th>
                    <td>{{telephonePatientInfo}}</td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </fieldset>
          </div>
          <div *ngIf="searchCatOption==1">
            <fieldset class="well the-fieldset">
              <legend class="the-legend">Personnel</legend>
              <div>
                <table class="table table-striped table-bordered table-hover" id="sample_5">
                  <tbody>
                  <tr>
                    <th>NOM</th>
                    <td>{{nomPersonnelInfo}}</td>
                    <th>PRENOM</th>
                    <td>{{prenomPersonnelInfo}}</td>
                    <th>STATUS</th>
                    <td>{{statusPersonnelInfo}}</td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </fieldset>
          </div>
          <div>
            <fieldset class="well the-fieldset">
              <legend class="the-legend">Documents</legend>
              <table class="table table-striped table-bordered table-hover">
                <thead>
                <tr>
                  <th>N&deg;</th>
                  <th>NOM</th>
                  <th>ACTION</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let document of responseDocumentInfo; index as i">
                  <td>{{i+1}}</td>
                  <td>{{document.name}}</td>
                  <td class="text-center">
                    <button type="button" title="Afficher le document" class="btn btn-primary btn-icon btn-sm"
                            (click)="showDocument(document.content)">
                      <i class="fa fa-eye"></i>
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
              <div class="text-center" *ngIf="responseDocumentInfo?.length==0">
                <i class="text-info">Aucune ligne trouvée.</i>
              </div>
            </fieldset>
          </div>
        </div>
      </div>
      <!--<div *ngIf="mode==0">
        <form class="form-horizontal">
          <div class="row">
            <div class="col-md-4" style="position: relative;left: 10%">
              <div *ngIf="searchCatOption==0" class="form-group">
                <label class="label-important">Patient</label>
                <ng-select2 [data]="dataPatient"
                            width="100%"
                            [(ngModel)]="searchPatient" name="searchPatient"
                            [placeholder]="'Sélectionner un patient...'">
                </ng-select2>
              </div>
              <div *ngIf="searchCatOption==1" class="form-group">
                <label class="label-important">Personnel</label>
                <ng-select2 [data]="dataPersonnel"
                            width="100%"
                            [(ngModel)]="searchPersonnel" name="searchPersonnel"
                            [placeholder]="'Sélectionner un personnel...'">
                </ng-select2>
              </div>
            </div>
            <div class="col-md-4" style="position: relative;left: 12%">
              <div class="form-group">
                <label class="label-important">Catégorie</label>
                <select #searchCategories class="form-control" (change)="searchCategorieChanged(searchCategories.value)"
                        name="searchCategorie" [(ngModel)]="searchCategorie">
                  <option disabled value=undefined>Sélectionner une catégorie....</option>
                  <option value=0>PATIENT</option>
                  <option value=1>PERSONNEL</option>
                </select>
                  <div *ngIf="searchInvalid" class="text-danger">catégorie est obligatoire</div>
              </div>
            </div>
            <div class="col-md-3" style="position: relative;left: 15%">
              <br>
              <button class="btn btn-dark" (click)="onSearch()">
                            <span class="btn-label">
                                <i class="fa fa-search"></i>
                            </span>
                Rechercher
              </button>
            </div>
          </div>
        </form>
        <ng-container *ngIf="(testResult$ | async) as result" [ngSwitch]="result.dataState">
          <ng-container *ngSwitchCase="DataSateEnum.LOADING">
            LOADING.....
          </ng-container>
          <ng-container *ngSwitchCase="DataSateEnum.ERROR">
            <div class="alert-danger">
              {{result.errorMessage}}
            </div>
          </ng-container>
          <ng-container *ngSwitchCase="DataSateEnum.LOADED">
            <div class="content table-responsive table-full-width container-fluid">
              <div class="toolbar">
                <div class="row">
                  <div class="col-md-4">
                    <div class="row">
                      <div class="col-md-12">
                        <label>
                          <strong>
                            Taille
                          </strong>
                        </label>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-4">
                        <select #taille class="form-control" name="taille" (change)="sizeChanged(taille.value)">
                          <option  *ngFor="let option of selectValues"
                                   value="{{option.value}}">{{option.value}}</option>
                        </select>
                      </div>
                      <div class="col-md-4"></div>
                    </div>
                  </div>
                  <div class="col-md-2"></div>
                  &lt;!&ndash;<div class="col-md-6" style="text-align: right">
                      <button class="btn btn-default" (click)="export()">
                          <i class="fa fa-download"></i>
                          Exporter
                      </button>
                  </div>&ndash;&gt;
                </div>
              </div>
              <table #table class="table table-striped">
                <thead style="text-align: center">
                <tr>
                  <th>N&deg;</th>
                  <th>DATE</th>
                  <th *ngIf="searchCatOption=='0'">NOM PATIENT</th>
                  <th *ngIf="searchCatOption=='0'">PRENOM PATIENT</th>
                  <th *ngIf="searchCatOption=='0'">TELEPHONE</th>
                  <th *ngIf="searchCatOption=='1'">NOM PERSONNEL</th>
                  <th *ngIf="searchCatOption=='1'">PRENOM PERSONNEL</th>
                  <th *ngIf="searchCatOption=='1'">STATUS</th>
                  <th>ACTION</th>
                </tr>
                </thead>
                <tbody style="text-align: center">
                <tr *ngFor="let testResult of result.data | paginate: {itemsPerPage: pageSize,
                                     currentPage: currentPage}; index as i">
                  <td>{{ (((currentPage-1)*pageSize)+1)+i }}</td>
                  <td>{{ testResult.date | date: 'dd/MM/yyyy' }}</td>
                  <td *ngIf="searchCatOption=='0'">{{ testResult.patient.nom }}</td>
                  <td *ngIf="searchCatOption=='0'">{{ testResult.patient.prenom }}</td>
                  <td *ngIf="searchCatOption=='0'">{{ testResult.patient.telephone }}</td>
                  <td *ngIf="searchCatOption=='1'">{{ testResult.personnel.lastName }}</td>
                  <td *ngIf="searchCatOption=='1'">{{ testResult.personnel.firstName }}</td>
                  <td *ngIf="searchCatOption=='1'">{{ testResult.personnel.status }}</td>
                  <td>
                    <button (click)="goToUpdate(testResult)" class="btn btn-dark btn-sm" title="modifier">
                      <i class="fa fa-edit"></i>
                    </button>&nbsp;
                    &lt;!&ndash;<button (click)="onGoToTime(testResult)" class="btn btn-secondary btn-sm" title="Time">
                      <i class="fa fa-id-badge"></i>
                    </button>&nbsp;&ndash;&gt;
                    <button (click)="showInfo(testResult)" class="btn btn-info btn-sm" title="Afficher detail">
                      <i class="fa fa-info"></i>
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
            <pagination-controls (pageChange)="pageChanged($event)"></pagination-controls>
          </ng-container>
          <div class="text-center" *ngIf="result.data?.length==0">
            <i class="text-info">Aucune ligne trouvée.</i>
          </div>
        </ng-container>
      </div>-->
    </div>
  </div>
</div>
